<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="专注于web和内网攻防研究,安全开发,安全运维,架构安全,热衷于高质量实用干货分享,提供全方位网络安全培训,更多请扫码关注自己博客下方的微信公众号,同时也期待更多志同道合的兄弟能一起并肩作战">
    

    <!--Author-->
    
        <meta name="author" content="klion">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="OpenVpn 安全部署实战指南 [一]"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="专注于web和内网攻防研究,安全开发,安全运维,架构安全,热衷于高质量实用干货分享,提供全方位网络安全培训,更多请扫码关注自己博客下方的微信公众号,同时也期待更多志同道合的兄弟能一起并肩作战" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="klion&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>OpenVpn 安全部署实战指南 [一] - klion&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    about me
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    blogs
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa " aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2014/12/09/hidsdesd-vpn/">
                OpenVpn 安全部署实战指南 [一]
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2014-12-09</span>
            
            
            
                <span class="category">
                    <a href="/categories/vpn-config/">vpn config</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p><br><br>0x01 关于openvpn<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">一种基于OpenSSL加密库的开源VPN实现,此处的主要目的还是旨在说明如何快速安全部署openvpn</div><div class="line">关于其内部的加解密细节及封装与解封装过程,相信大家都已经比较熟练了,此处不做过多涉及,暂以实战上手应用为主</div></pre></td></tr></table></figure></p>
<p>0x02 openvpn 可工作于两种不同的模式,使用 TUN / TAP 作为接口建立隧道,但需要相应内核支持<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">TUN 接口创建的是三层路由隧道,实际中用的较多,TAP 是二层网卡桥接隧道,即创建一个以太网桥接,相对复杂</div><div class="line">TAP 接口的好处在于,客户端可以获得 VPN 服务器所处子网的<span class="built_in"> IP </span>[即,忽略物理上的区别,可以完全将客户端看做是与VPN服务器处于同一子网的另一台机器]</div><div class="line">而TUN 接口下所有的客户端则处于一个完全独立的子网内,与 VPN 服务器所在的子网没有关系,待到后面实际部署时,会深有体会的</div></pre></td></tr></table></figure></p>
<p>0x03 下面则是 openvpn 提供的两种安全模式<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Static Key</div><div class="line">X509 PKI [Public Key Infrastructure]</div></pre></td></tr></table></figure></p>
<p>此次演示环境<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">OpenVpnServer</span>  	  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.3</span><span class="selector-class">.71</span> <span class="selector-attr">[假设为公网ip]</span>   <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.39</span> <span class="selector-attr">[假设为其所在的内网ip]</span> <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.7</span><span class="selector-class">.39</span> <span class="selector-attr">[假设为其所在的另一个内网ip]</span></div><div class="line"><span class="selector-tag">OpenVpnClient</span>	  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.41</span> <span class="selector-attr">[内网ip]</span> 	   <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.7</span><span class="selector-class">.41</span> <span class="selector-attr">[另一个内网ip段]</span>	为<span class="selector-tag">OpenVpnServer</span>所在内网段的一台<span class="selector-tag">linux</span>机器</div><div class="line"><span class="selector-tag">win7cn</span>		  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.253</span> <span class="selector-attr">[本地机器的内网ip]</span> 作为连接<span class="selector-tag">OpenVpnServer</span>的<span class="selector-tag">windows</span>访问客户端</div><div class="line"><span class="selector-tag">CentOS6</span><span class="selector-class">.8_x86_64</span>  <span class="selector-tag">ip</span>: 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.136</span> <span class="selector-attr">[本地机器的内网ip]</span> 作为连接<span class="selector-tag">OpenVpnServer</span>的<span class="selector-tag">linux</span>访问客户端</div></pre></td></tr></table></figure></p>
<p>我们要实现的最终目的<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">通过拨入 <span class="selector-tag">OpenVpnServer</span> 可在本地直接访问远程内网,即`192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.x</span>`和`192<span class="selector-class">.168</span><span class="selector-class">.6</span><span class="selector-class">.x</span>`,本身是两个完全独立相互不同的内网段</div><div class="line">但现在要实现的效果就是,可以直接在<span class="selector-tag">win7cn</span>或者<span class="selector-tag">CentOS6</span><span class="selector-class">.8</span>上<span class="selector-tag">ping</span>通<span class="selector-tag">OpenVpnServer</span>所在内网中的<span class="selector-tag">OpenVpnClient</span>机器</div></pre></td></tr></table></figure></p>
<p>0x04 Ok,明确了最终目的之后,我们就开始来实战部署OpenVpn</p>
<p>首先,进行一些前期的必要环境准备,务必严格保证所有机器时间完全一致,此项非常重要,否则后期OpenVpn客户端在连服务端时会出现证书无法被验证的情况<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /usr/sbin/ntpdate time.nist.gov  先手工在所有机器上同步一次,之后再加到计划任务中自动同步即可</span></div><div class="line"><span class="comment"># crontab -e</span></div><div class="line">  *<span class="regexp">/2 * * * * /usr</span><span class="regexp">/sbin/ntpdate</span> time.nist.gov &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line"><span class="comment"># crontab -l</span></div></pre></td></tr></table></figure></p>
<p>安装C编译器及openssl加密库,众所周知,openvpn依赖openssl对隧道数据进行加密<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> yum install -y  gcc gcc-c++ openssl openssl-devel</span></div></pre></td></tr></table></figure></p>
<p>禁用selinux,之后一定要记得重启下系统,才可生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> setenforce 0</span></div><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'/^SELINUX=/c\SELINUX=disabled'</span> /etc/selinux/config</span></div><div class="line"><span class="meta">#</span><span class="bash"> shutdown -r now</span></div></pre></td></tr></table></figure></p>
<p>准备好环境所需的源码包,此,分别为数据压缩库和openvpn自身的源码包<code>openvpn的下载地址可能已经被墙掉了,大家暂时挂ss下一下就好了</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget http://www.oberhumer.com/opensource/lzo/download/lzo-2.06.tar.gz</span></div><div class="line"><span class="comment"># wget https://build.openvpn.net/downloads/releases/openvpn-2.2.2.tar.gz</span></div></pre></td></tr></table></figure></p>
<p>编译安装LZO,主要用它来压缩通信数据加快传输速度<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> tar xf lzo-2.06.tar.gz</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> lzo-2.06</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./configure &amp;&amp; make &amp;&amp; make install</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> $?</span></div></pre></td></tr></table></figure></p>
<p>0x05 编译安装OpenVPN,记得要载入lzo一起编译<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tar -zxf openvpn-2.2.2.tar.gz</span></div><div class="line"><span class="comment"># cd openvpn-2.2.2</span></div><div class="line"><span class="comment"># ./configure --with-lzo-headers=/usr/local/lzo/include --with-lzo-lib=/usr/local/lzo/lib</span></div><div class="line"><span class="comment"># make &amp;&amp; make install</span></div><div class="line"><span class="comment"># echo $?</span></div><div class="line"><span class="comment"># which openvpn  如果能看到路径,说明openvpn已经基本安装成功,默认是在/usr/local/sbin/openvpn目录下</span></div></pre></td></tr></table></figure></p>
<p>0x06 安装成功后,我们就开始来实际部署配置OpenVpn</p>
<p>首先,修改默认证书信息,而后,以此来创建各种证书<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /root/openvpn-2.2.2/easy-rsa/2.0/ &amp;&amp; ll</span></div><div class="line"><span class="comment"># cp vars vars.bak</span></div><div class="line"><span class="comment"># vi vars</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_COUNTRY</span>=<span class="string">"CN"</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_PROVINCE</span>=<span class="string">"BJ"</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_CITY</span>=<span class="string">"BeiJing"</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_ORG</span>=<span class="string">"klionsec"</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_EMAIL</span>=<span class="string">"klion@rootkit.org"</span></div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_EMAIL</span>=klion@rootkit.org</div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_CN</span>=CN</div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_NAME</span>=kliosec</div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">KEY_OU</span>=klionsec</div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">PKCS11_MODULE_PATH</span>=changeme</div><div class="line">  <span class="builtin-name">export</span> <span class="attribute">PKCS11_PIN</span>=1234</div><div class="line"><span class="comment"># tail -n 11 vars</span></div><div class="line"><span class="comment"># source vars	重新载入,让变量生效</span></div><div class="line"><span class="comment"># ./clean-all  	把之前已有的证书全部先删掉</span></div><div class="line"><span class="comment"># ./build-ca   	创建ca证书ca.crt 及根密钥ca.key [基本上一路按回车就好],因为在vars文件中已经定义好了默认的变量值,生成时会自动逐个读取</span></div><div class="line"><span class="comment"># ll keys/   	看下刚刚生成的ca证书在keys目录里有没有</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/ca key.png" alt=""></p>
<p>创建服务端证书及密钥 <code>[ 中间会有一处让你输入密码,注意,后续创建证书时的密码最好都跟此密码保持一致,防止认证失败,之后再按照提示输入两次y即可]</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./build-key-server server</span></div><div class="line"><span class="meta">#</span><span class="bash"> ll keys/</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/server key.png" alt=""></p>
<p>创建完服务端证书和秘钥后,我们还需要为每一个登陆到OpenVpn服务器的客户端创建一个证书,注意直接用<code>build-key</code>创建的客户端证书默认是没密码的,也就是说,别人只要拿到你的这套客户端的证书就可以直接连上vpn服务器,有一定风险,当然,前提也得服务端配置中允许同一用户多点登陆才行,后续如果还要新增客户端用户,只需要再用build-key生成即可<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./build-key client  注意,这里也会提示输入密码,为了避免出问题,和上面创建服务端证书时设置的密码保持一致即可</span></div><div class="line"><span class="comment"># ll keys/</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/client key.png" alt=""><br><img src="/img/client key res.png" alt=""></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># ./<span class="keyword">build</span>-<span class="keyword">key</span>-pass clientsec 如果你想创建带密码的客户端证书,直接用 <span class="keyword">build</span>-<span class="keyword">key</span>-pass 来创建即可</div><div class="line"># ll <span class="keyword">keys</span>/</div></pre></td></tr></table></figure>
<p><img src="/img/client key pass.png" alt=""><br><img src="/img/client key pass res.png" alt=""></p>
<p>创建秘钥交换协议文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> ./build-dh    即迪菲·赫尔曼密钥,会生成dh1024.pem文件,生成过程可能会比较慢,在此期间不要去中断它</span></div><div class="line"><span class="meta">#</span><span class="bash"> ll keys/</span></div><div class="line"><span class="meta">#</span><span class="bash"> openvpn --genkey --secret keys/ta.key  生成ta.key文件,防DDos攻击,UDP淹没等恶意攻击,说实话,效果貌似并不太好</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/dh1024 key.png" alt=""></p>
<p>0x07 创建并修改openvpn服务器配置文件,将需要用到的openvpn证书和密钥复制一份到创建好的keys目录中<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir -pv /etc/openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root/openvpn-2.2.2/easy-rsa/2.0</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp -ap keys/ /etc/openvpn/</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ../../</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp sample-config-files/&#123;server.conf,client.conf&#125; /etc/openvpn/</span></div><div class="line"><span class="meta">#</span><span class="bash"> tree /etc/openvpn/</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span>  /etc/openvpn/</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp -a server.conf server.conf.bak</span></div><div class="line"><span class="meta">#</span><span class="bash"> grep <span class="string">'^[^#;]'</span> /etc/openvpn/server.conf &gt; tmp.txt</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat tmp.txt &gt; server.conf</span></div></pre></td></tr></table></figure></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 下面是openvpn服务端的完整配置</span></div><div class="line"><span class="meta"># vi server.conf</span></div><div class="line">  <span class="keyword">local</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.71</span>			 <span class="meta"># 要绑定到的公网ip</span></div><div class="line">  port <span class="number">11941</span>				 <span class="meta"># openvpn服务的默认端口,最好改掉,其实,别人如果全端口扫描还是能扫到 </span></div><div class="line">  proto tcp				 <span class="meta"># 使用tcp协议,相对稳定</span></div><div class="line">  dev tun				 <span class="meta"># 此处使用tun接口</span></div><div class="line">  ca /etc/openvpn/keys/ca.crt		 <span class="meta"># ca证书路径</span></div><div class="line">  cert /etc/openvpn/keys/server.crt	 </div><div class="line">  <span class="built_in">key</span> /etc/openvpn/keys/server.<span class="built_in">key</span>	 <span class="meta"># openvpn服务端证书路径 </span></div><div class="line">  dh /etc/openvpn/keys/dh1024.pem	 </div><div class="line">  server <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>	 <span class="meta"># openvpn内网ip地址池 </span></div><div class="line">  <span class="keyword">push</span> <span class="string">"route 192.168.6.0 255.255.255.0"</span> <span class="meta"># 此项非常重要,即vpn服务器所在的内网段</span></div><div class="line">  <span class="keyword">push</span> <span class="string">"route 192.168.7.0 255.255.255.0"</span> <span class="meta"># 如果想让别人拨入成功后能直接跟vpn所在的内网段的机器进行通信,就需要用此方式把配置推到每个客户端</span></div><div class="line">  client-to-client			 <span class="meta"># 让openvpn客户端和客户端能相互通信</span></div><div class="line">  duplicate-cn				 <span class="meta"># 同一个vpn账号允许同时多点登陆,在上面已经提到过</span></div><div class="line">  ifconfig-pool-persist ipp.txt		 </div><div class="line">  keepalive <span class="number">10</span> <span class="number">120</span>			 <span class="meta"># 发心跳包,每10一次,如果超过120秒都没动静,就自动断开</span></div><div class="line">  comp-lzo				 <span class="meta"># 启用传输数据压缩</span></div><div class="line">  persist-<span class="built_in">key</span>		</div><div class="line">  persist-tun				 </div><div class="line">  status openvpn-status.<span class="built_in">log</span>		 <span class="meta"># 开启OpenVpn服务端日志</span></div><div class="line">  <span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn.<span class="built_in">log</span>		 <span class="meta"># 指定日志存放位置</span></div><div class="line">  verb <span class="number">3</span>				 <span class="meta"># 指定记录的日志级别</span></div></pre></td></tr></table></figure>
<p>0x08 修改完OpenVpn服务端配置后,我们再来稍微调整一些系统配置,如下</p>
<p>开启系统路由转发,因为在拨入成功后还要访问vpn服务器所在内网中的其它机器,所以转发是必须的<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> sed -i <span class="string">'/net.ipv4.ip_forward/s/0/1/'</span> /etc/sysctl.conf</span></div><div class="line"><span class="meta">#</span><span class="bash"> sysctl -p</span></div></pre></td></tr></table></figure></p>
<p>如果开了iptables,记得把tcp的11941端口<code>[实际中是你自己设置的openvpn服务端口]</code>和转发都放开,不然客户端可能会连不上,如果压根没开,可暂时不用管<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/sysconfig/iptables</span></div><div class="line">  -A INPUT -p tcp --dport 11941 -j ACCEPT</div><div class="line"><span class="meta">#</span><span class="bash"> iptables -A INPUT -p tcp --dport 11941 -j ACCEPT</span></div><div class="line"><span class="meta">#</span><span class="bash"> iptables -L -n</span></div><div class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/iptables status</span></div></pre></td></tr></table></figure></p>
<p>最后,我们来尝试启动OpenVpn服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/openvpn --config /etc/openvpn/server.conf &amp;</span></div><div class="line"><span class="meta">#</span><span class="bash"> netstat -tulnp | grep openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"/usr/local/sbin/openvpn --config /etc/openvpn/server.conf &amp;"</span> &gt;&gt; /etc/rc.local</span></div><div class="line"><span class="meta">#</span><span class="bash"> tail -n 1 /etc/rc.local</span></div><div class="line"><span class="meta">#</span><span class="bash"> ifconfig  -a  openvpn服务一旦成功启动系统中就会多出一个名为tun0的虚拟网卡</span></div><div class="line"><span class="meta">#</span><span class="bash"> pkill openvpn</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn start.png" alt=""><br><img src="/img/openvpn start res.png" alt=""></p>
<p>当然,除了手工去加载服务端配置文件来启动,你也可以用openvpn自己提供好的服务启动脚本来配置成常规启动,只是自己不太喜欢这样搞,过程非常简单,如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> cp /root/openvpn-2.2.2/sample-scripts/openvpn.init /etc/init.d/openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> chmod 700 /etc/init.d/openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> chkconfig openvpn on</span></div><div class="line"><span class="meta">#</span><span class="bash"> chkconfig --list</span></div><div class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart  会有报错</span></div><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/init.d/openvpn       把148行的*.conf改成server.conf,这个目录下不能有多个.conf否则就会被干扰到</span></div><div class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart  正常启动</span></div><div class="line"><span class="meta">#</span><span class="bash"> lsof -i :1194</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn start initd.png" alt=""><br><img src="/img/openvpn start log.png" alt=""></p>
<p>0x09 把服务端完全搞定以后,我们再来看如何在不同系统平台下配置OpenVpn客户端进行连接</p>
<p>先下载并安装好 OpenVpn 的windows版客户端工具,地址已被墙<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>/<span class="regexp">/swupdate.openvpn.org/community</span><span class="regexp">/releases/openvpn</span>-<span class="number">2.2</span>.<span class="number">2</span>-install.exe</div></pre></td></tr></table></figure></p>
<p>此时,再到OpenVpn服务端去把指定客户端的证书及配置文件都下载下来<code>[此处以client用户为例]</code>,之后再把这些文件全部复制到你OpenVpn客户端的config目录中,此处的OpenVpn客户端config目录是在如下的路径上,而你则要根据你自己的OpenVpn客户端安装目录来调整<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/openvpn/keys/</span></div><div class="line"><span class="meta">#</span><span class="bash"> sz ca.crt client.crt client.key</span></div></pre></td></tr></table></figure></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ca<span class="selector-class">.crt</span> client<span class="selector-class">.crt</span> client<span class="selector-class">.key</span>  	所有要复制的文件</div><div class="line">C:\Program Files\OpenVPN\config	要复制到的目录</div></pre></td></tr></table></figure>
<p><img src="/img/openvpn client install.png" alt=""><br><img src="/img/openvpn client install res.png" alt=""><br><img src="/img/openvpn client download.png" alt=""></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 手工创建好客户端配置文件,文件具体内容如下,注意在windows中客户端配置文件名必须为 client.ovpn </span></div><div class="line"><span class="built_in"></span></div><div class="line">client			  # 声明是客户端</div><div class="line">dev tun			  # 和服务端保持一致,使用tun接口</div><div class="line">proto tcp		  # 同样使用tcp协议,保持一致,不然就没法和服务端进行正常通信了</div><div class="line">remote 192.168.3.71 11941 # Openvpn 服务端的ip和端口</div><div class="line">resolv-retry infinite</div><div class="line">nobind</div><div class="line">persist-key</div><div class="line">persist-tun</div><div class="line">ca ca.crt		  # 客户端证书所在路径</div><div class="line">cert client.crt</div><div class="line">key client.key</div><div class="line">ns-cert-type<span class="built_in"> server</span></div><div class="line">comp-lzo		  # 压缩传输</div><div class="line">verb 3</div></pre></td></tr></table></figure>
<p>之后,再右键以<code>管理员权限</code>运行openvpn客户端,点击<code>connect</code> 进行连接即可,如下即表示连接成功,至此,整个OpenVpn的部署工作也就完成了百分之八十,但我们的最终目的是希望能在本地通过拨入vpn直接跟远程内网中的机器进行通信,再次明确目的之后,我们继续</p>
<p><img src="/img/openvpn client connect res.png" alt=""><br><img src="/img/openvpn client connect.png" alt=""></p>
<p>0x10 以上是使用windows客户端来连接OpenVpn服务端,至于如何在linux中使用客户端连接OpenVpn服务端就更简单了,跟OpenVpn服务端一样,先装好OpenVpn,之后只需用openvpn工具加载对应的客户端配置文件即可,注意,是客户端配置文件,另外,此处不需要再配置服务端,单单只是用下openvpn工具而已,具体如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /etc/openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/openvpn</span></div><div class="line"><span class="meta">#</span><span class="bash"> rz  可以直接把刚刚client的一套证书丢上去</span></div><div class="line"><span class="meta">#</span><span class="bash"> tree ./</span></div><div class="line"> ├── ca.crt</div><div class="line"> ├── client.conf</div><div class="line"> ├── client.crt</div><div class="line"> └── client.key</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> 断开以后,第二次重连可能会有些问题,把客户端配置文件改个名就好了</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/sbin/openvpn --config /etc/openvpn/client.conf &amp;</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/linux conenect in.png" alt=""></p>
<p>0x11 再回到我们的最终目的上,<code>如何在本地通过vpn直接跟远程内网进行通信</code>,方式大概有三种,如下</p>
<p>第一种,把所有要通信的远程内网中的机器的网关都指向OpenVpn服务器的ip,这样,包在回传的时候就能找到本地机器,为了防止重启即失效,可直接把命令放在<code>rc.local</code>中<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># route add <span class="section">default</span> gw <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>  在OpenVpnClient上添加如下指向</div><div class="line"># route -n</div></pre></td></tr></table></figure></p>
<p><img src="/img/openvpn in net .png" alt=""><br><img src="/img/openvpn in net res .png" alt=""></p>
<p>第二种,走网段路由,在所有要通信的内网的机器上添加如下路由,把来自vpn内网段的数据都直接丢到OpenVpn服务器指定的内网ip上,一样也可以达到目的,但两种方式有个共同的确定,机器比较少的情况下也许还能凑活,如果有几千台机器,每台上都要添加一条这样的指向毕竟是很不现实的<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># route add -net <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> gw <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>  在OpenVpnClient上添加如下指向</div><div class="line"># route -n</div></pre></td></tr></table></figure></p>
<p><img src="/img/secode network.png" alt=""><br><img src="/img/secode network res.png" alt=""></p>
<p>所以,我们再来看第三种,利用iptables进行NAT转换,即把源地址为<code>10.18.0.0/24</code>都转换到指定的内网卡ip上,这样就不用再逐个指定网关了<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># /etc/init.d/iptables status  只需在OpenVpnServer服务器上添加如下规则即可</div><div class="line"># /sbin/iptables -t nat -A POSTROUTING -s <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> -o eth2 -j SNAT --to-source <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>	添加规则</div><div class="line"># /sbin/iptables -t nat -D POSTROUTING -s <span class="number">10.18</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> -o eth2 -j SNAT --to-source <span class="number">192.168</span><span class="number">.7</span><span class="number">.39</span>	删除规则</div><div class="line"># /etc/init.d/iptables stop</div></pre></td></tr></table></figure></p>
<p><img src="/img/iptables three.png" alt=""><br><img src="/img/iptables three res.png" alt=""></p>
<p>0x12 实际生产环境中,由于各种各样的原因,有时可能还需要禁止指定的客户端用户登陆,方法非常简单,直接注销指定的客户端证书,万一要连续禁用多个vpn账号,那就直接一次性注销多个客户端证书,执行revoke-full后直接覆盖原来的crl.pem文件即可,如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root/openvpn-2.2.2/easy-rsa/2.0</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">source</span> vars</span></div><div class="line"><span class="meta">#</span><span class="bash"> vi /root/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf</span></div><div class="line"><span class="meta">#</span><span class="bash"> tail -n 6 /root/openvpn-2.2.2/easy-rsa/2.0/openssl-1.0.0.cnf	先注释如下行</span></div><div class="line"><span class="meta">  #</span><span class="bash">[ pkcs11_section ]</span></div><div class="line"><span class="meta">  #</span><span class="bash">engine_id = pkcs11</span></div><div class="line"><span class="meta">  #</span><span class="bash">dynamic_path = /usr/lib/engines/engine_pkcs11.so</span></div><div class="line"><span class="meta">  #</span><span class="bash">MODULE_PATH = <span class="variable">$ENV</span>::PKCS11_MODULE_PATH</span></div><div class="line"><span class="meta">  #</span><span class="bash">PIN = <span class="variable">$ENV</span>::PKCS11_PIN</span></div><div class="line"><span class="meta">  #</span><span class="bash">init = 0</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./revoke-full client	指定要注销的客户端用户执行注销</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat keys/crl.pem</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat keys/index.txt	从该文件中可看到客户端用户的状态,R为已注销</span></div><div class="line"><span class="meta">#</span><span class="bash"> cp keys/crl.pem /etc/openvpn/keys/</span></div><div class="line"><span class="meta">#</span><span class="bash"> vi /etc/openvpn/server.conf	再到主配置文件中添加该pem文件位置,然后重启openvpn,该用户登陆即会失效</span></div><div class="line">  crl-verify /etc/openvpn/keys/crl.pem</div><div class="line"><span class="meta">#</span><span class="bash"> /etc/init.d/openvpn restart</span></div></pre></td></tr></table></figure></p>
<p>下面是vpn账户被禁用后再登陆的效果,你会发现客户端的连接在一直被reset掉</p>
<p><img src="/img/client error.png" alt=""></p>
<p><br></p>
<p>后话:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vpn作为直插目标内部的一个最直接的入口,也颇受入侵者的热爱,尤其是对各种APT团队来讲更是如此,针对此所进行的各种形式的钓鱼也从未休止</div><div class="line">其实,关于openvpn自身的漏洞并不多,甚至可以说,几乎没有,有也只是一些第三方库的,另外,基本也不存在什么错误配置能辅助我们渗透的</div><div class="line">关于openvpn的内部通信过程,大家可自行拿wireshark<span class="meta">&amp;tcpdump仔细好好跟一下基本就看明白了,如果真想深入研究建议直接去阅读2.2的源码</span></div><div class="line">在部署上基本无任何技术含量,只是为了方便大家用,顺便给自己做个备忘,保证后续随时能用即可</div></pre></td></tr></table></figure></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/openvpn/">#openvpn</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">

<center>
<span>有偿提供各类全面靠谱的安全优化加固方案,入侵取证及全方位企业内部及个人网络安全培训...<font color="red"> &nbsp;&nbsp;klion@protonmail.com</span><br>
<br>
<br>
<font size="5" color="#00FF7F" style="margin-left=-10px;">关注公众号</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font size="5" color="#00FF7F">随意捐助 [ 微信 ]</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font size="5" color="#00FF7F">加入小密圈</font>
<br>
<br>
<img src="/img/small.jpg"  alt="klionsec" />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/klion.png" with="262" height="254" alt="klionsec" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/xiaomi.png" with="260" height="257">
<br><br>
<br><font color="yellow" size="4">
如果觉得内容还不错,也希望您能高抬贵手帮忙转发一下,让更多需要的人都能看到,本人不胜感激
</font><br><br>
<font color="#00FF7F" size="4">
相信您的支持和鼓励换来的将会是更高质量的不懈创作,本人将一直秉承博客初衷,坚持高质量原创实用干货分享</font>
<br><br><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">博客累计访问量 <span id="busuanzi_value_site_pv"></span> </span>
<span id="busuanzi_container_site_uv">
累计访客数 <span id="busuanzi_value_site_uv"></span> 
</span>
<span id="showDays"></span>
<script>
var birthDay = new Date("12/28/2014");
var now = new Date();
var duration = now.getTime() - birthDay.getTime(); 
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = " 其实,博客已默默独自坚挺了 "+total+" 天";
</script>
<br>
<br>
多年实战渗透经验积累[大中小型网络] + 娴熟的底层及脚本编写能力 + 熟练的协议分析能力 + 多个大中型安全架构实际设计部署经验 + 良好的逆向分析能力[一定的0day挖掘能力] = 合格安全架构师
<br>
<br>
<br>
<font size=6 color="white">唯一不变的,就是一直在变</font>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="http://www.jianshu.com/u/2a4d8b1f03e0">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.zhihu.com/people/klionsec/activities">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:klion@protonmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    <strong><font size=4 color=#00FF7F> Blog by klionsec </font></strong>
                </div>
            </div>
        </div>
    </div>
<!--
<audio autoplay="autoplay" width="300" height="200">
	<source src="/img/Bandari - Childhood Memory.mp3" type="audio/mpeg" />
</audio>
-->
</footer>



<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>